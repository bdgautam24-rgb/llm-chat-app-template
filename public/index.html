<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>‡¶∏‡¶®‡¶æ‡¶§‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
  <style>
    :root {
      --primary: #f6821f;
      --primary-hover: #e67e22;
      --bg: #f9fafb;
      --text: #1f2937;
      --border: #e5e7eb;
      --user-bg: #fff2e6;
      --assistant-bg: #f3f4f6;
      --avatar-size: 40px;
    }
    [data-theme="dark"] {
      --bg: #111827;
      --text: #f3f4f6;
      --border: #374151;
      --user-bg: #7c2d12;
      --assistant-bg: #1f2937;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 800px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background 0.3s;
    }

    header {
      text-align: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .agent-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    h1 { font-size: 1.2rem; color: var(--primary); }
    .theme-toggle {
      position: absolute; top: 1rem; right: 1rem;
      background: none; border: none; font-size: 1.5rem; cursor: pointer;
    }

    .chat-container {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: env(safe-area-inset-bottom, 1rem);
    }

    .message-wrapper {
      display: flex;
      margin-bottom: 1rem;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.3s forwards;
    }
    @keyframes fadeInUp { to { opacity: 1; transform: none; } }

    .user-message-wrapper { justify-content: flex-end; }
    .assistant-message-wrapper { justify-content: flex-start; }

    .avatar {
      width: var(--avatar-size);
      height: var(--avatar-size);
      border-radius: 50%;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .user-avatar { background: var(--primary); margin-left: 0.5rem; }
    .assistant-avatar { background: #3b82f6; margin-right: 0.5rem; }

    .message {
      padding: 0.75rem;
      border-radius: 12px;
      max-width: 75%;
      position: relative;
      word-wrap: break-word;
    }
    .user-message {
      background: var(--user-bg);
      border-bottom-right-radius: 0;
    }
    .assistant-message {
      background: var(--assistant-bg);
      border-bottom-left-radius: 0;
    }

    .copy-btn {
      position: absolute;
      top: 4px; right: 8px;
      background: none; border: none;
      font-size: 1rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message:hover .copy-btn { opacity: 1; }

    .timestamp {
      font-size: 0.7rem;
      color: #9ca3af;
      text-align: right;
      margin-top: 4px;
    }

    /* Typing Indicator */
    #typing-indicator-wrapper {
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      height: 0;
      overflow: hidden;
      margin-bottom: 0;
    }
    #typing-indicator-wrapper.visible {
      opacity: 1;
      visibility: visible;
      height: auto;
      margin-bottom: 1rem;
    }
    .typing-bubble {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0.5rem;
      background: var(--assistant-bg);
      border-radius: 12px;
      border-bottom-left-radius: 0;
      width: fit-content;
    }
    .typing-dot {
      width: 8px; height: 8px;
      background: #6b7280;
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    .message-input {
      display: flex;
      padding: 0.75rem;
      border-top: 1px solid var(--border);
      background: var(--bg);
      gap: 0.5rem;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0));
    }
    #user-input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
      font-size: 16px;
    }
    #send-button {
      padding: 0 1.2rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    #send-button:disabled { background: #9ca3af; cursor: not-allowed; }

    @media (max-width: 480px) {
      .message { max-width: 85%; }
      header { padding: 0.75rem; }
    }
  </style>
</head>
<body>

  <button class="theme-toggle" id="theme-toggle" aria-label="‡¶•‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®">üåô</button>

  <header>
    <div class="agent-icon">üî±</div>
    <h1>‡¶∏‡¶®‡¶æ‡¶§‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</h1>
    <p>‡¶ê‡¶§‡¶ø‡¶π‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ì ‡¶Ø‡ßå‡¶ï‡ßç‡¶§‡¶ø‡¶ï ‡¶Ü‡¶≤‡ßã‡¶ö‡¶®‡¶æ</p>
  </header>

  <div class="chat-container">
    <div id="chat-messages" role="log" aria-live="polite" aria-busy="false">
      <div class="message-wrapper assistant-message-wrapper">
        <div class="avatar assistant-avatar">üî±</div>
        <div class="message assistant-message">
          <p>‡¶®‡¶Æ‡¶∏‡ßç‡¶ï‡¶æ‡¶∞! ‡¶Ü‡¶Æ‡¶ø ‡¶ó‡ßå‡¶§‡¶Æ ‡¶ï‡ßÅ‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?</p>
          <div class="timestamp">‡¶è‡¶ñ‡¶®</div>
        </div>
      </div>

      <div class="message-wrapper assistant-message-wrapper" id="typing-indicator-wrapper">
        <div class="avatar assistant-avatar">üî±</div>
        <div class="typing-bubble">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>

    <div class="message-input">
      <textarea id="user-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." rows="1"></textarea>
      <button id="send-button">‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script>
    // === DOM Elements ===
    const chatMessages = document.getElementById("chat-messages");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    const typingIndicator = document.getElementById("typing-indicator-wrapper");
    const themeToggle = document.getElementById("theme-toggle");

    // === State ===
    let chatHistory = [
      { role: "assistant", content: "‡¶®‡¶Æ‡¶∏‡ßç‡¶ï‡¶æ‡¶∞! ‡¶Ü‡¶Æ‡¶ø ‡¶ó‡ßå‡¶§‡¶Æ ‡¶ï‡ßÅ‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?" }
    ];
    let isProcessing = false;
    let typingTimeout = null;

    // === Load Theme & History ===
    const savedTheme = localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
    document.documentElement.setAttribute("data-theme", savedTheme);
    themeToggle.textContent = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";

    const savedHistory = localStorage.getItem("chatHistory");
    if (savedHistory) {
      chatHistory = JSON.parse(savedHistory);
      renderHistory();
    }

    // === Theme Toggle ===
    themeToggle.addEventListener("click", () => {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      const newTheme = isDark ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", newTheme);
      themeToggle.textContent = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("theme", newTheme);
    });

    // === Auto-resize textarea ===
    userInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    });

    // === Enter to send ===
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendButton.addEventListener("click", sendMessage);

    // === Scroll to bottom only if near bottom ===
    function isScrolledToBottom() {
      return chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 100;
    }
    function scrollToBottom() {
      if (isScrolledToBottom()) {
        chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
      }
    }

    // === Add message ===
    function addMessage(role, content, timestamp = new Date()) {
      const wrapper = document.createElement("div");
      wrapper.className = `message-wrapper ${role}-message-wrapper`;

      const avatar = document.createElement("div");
      avatar.className = `avatar ${role}-avatar`;
      avatar.textContent = role === "user" ? "User" : "Assistant";
      avatar.setAttribute("aria-hidden", "true");

      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${role}-message`;

      const p = document.createElement("p");
      p.innerHTML = DOMPurify.sanitize(marked.parse(content));
      messageDiv.appendChild(p);

      const time = document.createElement("div");
      time.className = "timestamp";
      time.textContent = timestamp.toLocaleTimeString("bn-BD", { hour: "2-digit", minute: "2-digit" });
      messageDiv.appendChild(time);

      if (role === "assistant") {
        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.innerHTML = "Copy";
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(content);
          copyBtn.innerHTML = "Checkmark";
          setTimeout(() => copyBtn.innerHTML = "Copy", 2000);
        };
        messageDiv.appendChild(copyBtn);
      }

      if (role === "user") {
        wrapper.appendChild(messageDiv);
        wrapper.appendChild(avatar);
      } else {
        wrapper.appendChild(avatar);
        wrapper.appendChild(messageDiv);
      }

      chatMessages.appendChild(wrapper);
      scrollToBottom();
    }

    // === Render saved history ===
    function renderHistory() {
      chatMessages.innerHTML = "";
      chatHistory.forEach(msg => {
        if (msg.role !== "system") addMessage(msg.role, msg.content);
      });
      scrollToBottom();
    }

    // === Send Message ===
    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message || isProcessing) return;

      isProcessing = true;
      userInput.disabled = true;
      sendButton.disabled = true;

      addMessage("user", message);
      chatHistory.push({ role: "user", content: message });
      userInput.value = "";
      userInput.style.height = "auto";

      // Show typing
      typingIndicator.classList.add("visible");
      chatMessages.setAttribute("aria-busy", "true");
      scrollToBottom();

      // Create assistant placeholder
      const assistantWrapper = document.createElement("div");
      assistantWrapper.className = "message-wrapper assistant-message-wrapper";
      const avatar = document.createElement("div");
      avatar.className = "avatar assistant-avatar";
      avatar.textContent = "Assistant";
      const messageDiv = document.createElement("div");
      messageDiv.className = "message assistant-message";
      const p = document.createElement("p");
      messageDiv.appendChild(p);
      assistantWrapper.appendChild(avatar);
      assistantWrapper.appendChild(messageDiv);
      chatMessages.appendChild(assistantWrapper);

      // Hide typing, start streaming
      typingIndicator.classList.remove("visible");
      chatMessages.setAttribute("aria-busy", "false");

      let fullResponse = "";
      let displayed = "";

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: chatHistory })
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        const typeChar = () => {
          if (displayed.length < fullResponse.length) {
            displayed += fullResponse.charAt(displayed.length);
            p.innerHTML = DOMPurify.sanitize(marked.parse(displayed));
            scrollToBottom();
            typingTimeout = setTimeout(typeChar, 20 + Math.random() * 30);
          } else {
            finalizeMessage();
          }
        };

        const finalizeMessage = () => {
          chatHistory.push({ role: "assistant", content: fullResponse });
          localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
          // Add copy button
          const copyBtn = document.createElement("button");
          copyBtn.className = "copy-btn";
          copyBtn.innerHTML = "Copy";
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(fullResponse);
            copyBtn.innerHTML = "Checkmark";
            setTimeout(() => copyBtn.innerHTML = "Copy", 2000);
          };
          messageDiv.appendChild(copyBtn);

          const time = document.createElement("div");
          time.className = "timestamp";
          time.textContent = new Date().toLocaleTimeString("bn-BD", { hour: "2-digit", minute: "2-digit" });
          messageDiv.appendChild(time);

          userInput.disabled = false;
          sendButton.disabled = false;
          userInput.focus(); // Only after full message
          isProcessing = false;
        };

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          const lines = chunk.split("\n");
          for (const line of lines) {
            if (line.trim() && line.includes('"response"')) {
              try {
                const data = JSON.parse(line);
                if (data.response) {
                  fullResponse += data.response;
                  if (!typingTimeout) typeChar();
                }
              } catch (e) {}
            }
          }
        }
        clearTimeout(typingTimeout);
        displayed = fullResponse;
        p.innerHTML = DOMPurify.sanitize(marked.parse(displayed));
        finalizeMessage();

      } catch (err) {
        p.innerHTML = "‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ò‡¶ü‡ßá‡¶õ‡ßá‡•§";
        isProcessing = false;
        userInput.disabled = false;
        sendButton.disabled = false;
      }
    }

    // === Initial focus ===
    userInput.focus();
  </script>
</body>
</html>
