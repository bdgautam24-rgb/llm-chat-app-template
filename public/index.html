<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</title>
    
    <!-- ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    
    <style>
        /* ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        body {
            font-family: 'Noto Sans Bengali', sans-serif; /* ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶´‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        }
        .bg-user-bg { background-color: #DCF8C6; }
        .bg-assistant-bg { background-color: #FFFFFF; border: 1px solid #f0f0f0; }
        #chat-messages {
            height: calc(100vh - 140px );
        }
        
        /* ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶á‡¶®‡ßç‡¶°‡¶ø‡¶ï‡ßá‡¶ü‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶æ‡¶â‡¶®‡ßç‡¶∏ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        .dot-bounce {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot-bounce:nth-child(1) {
            animation-delay: -0.32s;
        }
        .dot-bounce:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <div id="chat-container" class="flex-grow flex flex-col max-w-3xl mx-auto w-full">
        <!-- ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶•‡¶æ‡¶® -->
        <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto bg-white rounded-t-lg shadow-inner">
            <!-- ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶¨‡ßá -->
        </div>
        
        <!-- ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶Ö‡¶Ç‡¶∂ -->
        <div class="p-4 bg-gray-200 rounded-b-lg shadow-md">
            <div class="flex items-center bg-white rounded-lg border border-gray-300 focus-within:ring-2 focus-within:ring-blue-500">
                <textarea id="user-input" class="flex-grow p-3 border-none rounded-lg resize-none focus:outline-none" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." rows="1"></textarea>
                <button id="send-button" class="ml-2 mr-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </button>
            </div>
        </div>
    </div>

<script>
    // === DOM Elements ===
    const chatMessages = document.getElementById("chat-messages" );
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");

    // === State ===
    let chatHistory = [
      { role: "assistant", content: "‡¶®‡¶Æ‡¶∏‡ßç‡¶ï‡¶æ‡¶∞! ‡¶Ü‡¶Æ‡¶ø ‡¶ó‡ßå‡¶§‡¶Æ ‡¶ï‡ßÅ‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?" }
    ];
    let isProcessing = false;

    // === Load History on Page Load ===
    document.addEventListener("DOMContentLoaded", () => {
      const savedHistory = localStorage.getItem("chatHistory");
      const savedTimestamp = parseInt(localStorage.getItem("chatTimestamp"), 10);
      const currentTime = Date.now();
      const expirationTime = 30 * 60 * 1000; // ‡ß©‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü

      if (savedHistory && savedTimestamp && (currentTime - savedTimestamp < expirationTime)) {
        try {
          chatHistory = JSON.parse(savedHistory);
        } catch (e) {
          console.error("‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá:", e);
          localStorage.clear();
        }
      } else {
        localStorage.removeItem("chatHistory");
        localStorage.removeItem("chatTimestamp");
      }
      renderHistory();
      userInput.focus();
    });

    // === Event Listeners ===
    userInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = (this.scrollHeight) + "px";
    });

    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendButton.addEventListener("click", sendMessage);

    // === UI Helper Functions ===
    function scrollToElement(element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function scrollToBottom() {
      chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
    }

    function addMessage(role, content, timestamp = new Date()) {
      const isUser = role === "user";
      const wrapper = document.createElement("div");
      wrapper.className = "clearfix mb-4";

      const avatar = document.createElement("div");
      avatar.className = `w-10 h-10 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0 ${isUser ? 'bg-green-500' : 'bg-blue-500'}`;
      avatar.textContent = isUser ? "üë§" : "üî±";
      avatar.style.float = isUser ? "right" : "left";

      const messageDiv = document.createElement("div");
      messageDiv.className = `inline-block max-w-[75%] p-3 rounded-lg relative group shadow ${isUser ? 'bg-user-bg rounded-br-none' : 'bg-assistant-bg rounded-bl-none'}`;
      messageDiv.style.float = isUser ? "right" : "left";
      messageDiv.style.marginLeft = isUser ? "auto" : "12px";
      messageDiv.style.marginRight = isUser ? "12px" : "auto";

      const p = document.createElement("p");
      p.innerHTML = DOMPurify.sanitize(marked.parse(content));
      messageDiv.appendChild(p);

      const time = document.createElement("div");
      time.className = "text-xs text-gray-400 text-right mt-1";
      time.textContent = timestamp.toLocaleTimeString("bn-BD", { hour: "2-digit", minute: "2-digit" });
      messageDiv.appendChild(time);

      if (role === "assistant") {
        const copyBtn = document.createElement("button");
        copyBtn.className = "absolute top-1 right-2 bg-transparent border-none text-gray-400 text-lg cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity";
        copyBtn.innerHTML = "üìã";
        copyBtn.setAttribute('aria-label', '‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®');
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(content).then(() => {
            copyBtn.innerHTML = "‚úÖ";
            setTimeout(() => { copyBtn.innerHTML = "üìã"; }, 2000);
          });
        };
        messageDiv.appendChild(copyBtn);
      }

      wrapper.appendChild(avatar);
      wrapper.appendChild(messageDiv);
      chatMessages.appendChild(wrapper);
      scrollToBottom();
      return messageDiv;
    }

    function renderHistory() {
      chatMessages.innerHTML = "";
      chatHistory.forEach(msg => {
        if (msg.role !== "system") {
          addMessage(msg.role, msg.content);
        }
      });
      scrollToBottom();
    }

    function showTypingIndicator() {
      const wrapper = document.createElement("div");
      wrapper.id = "typing-indicator";
      wrapper.className = "clearfix mb-4";
      wrapper.innerHTML = `
        <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold flex-shrink-0 float-left">üî±</div>
        <div class="inline-block max-w-[75%] bg-assistant-bg p-4 rounded-lg rounded-bl-none ml-12 float-left shadow">
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-gray-500 rounded-full dot-bounce"></div>
            <div class="w-2 h-2 bg-gray-500 rounded-full dot-bounce"></div>
            <div class="w-2 h-2 bg-gray-500 rounded-full dot-bounce"></div>
          </div>
        </div>
      `;
      chatMessages.appendChild(wrapper);
      scrollToBottom();
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById("typing-indicator");
      if (indicator) indicator.remove();
    }

    function setProcessingState(state) {
      isProcessing = state;
      userInput.disabled = state;
      sendButton.disabled = state;
      if (!state) {
        userInput.focus();
      }
    }

    // === Core Send Message Logic (Final Version) ===
    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message || isProcessing) return;

        setProcessingState(true);
        addMessage("user", message);
        chatHistory.push({ role: "user", content: message });
        userInput.value = "";
        userInput.style.height = "auto";
        showTypingIndicator();

        let assistantMessageDiv; 

        try {
            const res = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ messages: chatHistory }),
            });

            if (!res.ok) {
                throw new Error(`‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${res.status} ${res.statusText}`);
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = "";
            let buffer = "";
            let receivedData = false;

            removeTypingIndicator();
            assistantMessageDiv = addMessage("assistant", ""); 
            const assistantContentP = assistantMessageDiv.querySelector("p");
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                receivedData = true;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n");
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.trim().startsWith("data:")) {
                        try {
                            const jsonStr = line.replace("data:", "").trim();
                            if (jsonStr) {
                                const data = JSON.parse(jsonStr);
                                if (data.response) {
                                    fullResponse += data.response;
                                    assistantContentP.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                                    scrollToElement(assistantMessageDiv);
                                }
                            }
                        } catch (e) {
                            console.error("JSON ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡¶ø‡¶Ç ‡¶è ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:", e, "‡¶≤‡¶æ‡¶á‡¶®:", line);
                        }
                    }
                }
            }

            if (!receivedData && !fullResponse) {
                throw new Error("‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá‡¶õ‡ßá‡•§");
            }

            const finalCopyBtn = assistantMessageDiv.querySelector('button[aria-label="‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®"]');
            if (finalCopyBtn) {
                finalCopyBtn.onclick = () => {
                    navigator.clipboard.writeText(fullResponse).then(() => {
                        finalCopyBtn.innerHTML = "‚úÖ";
                        setTimeout(() => { finalCopyBtn.innerHTML = "üìã"; }, 2000);
                    });
                };
            }

            if (fullResponse) {
                chatHistory.push({ role: "assistant", content: fullResponse });
                localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
                localStorage.setItem("chatTimestamp", Date.now().toString());
            }

        } catch (err) {
            console.error("API ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá:", err);
            removeTypingIndicator();
            
            if (assistantMessageDiv) {
                assistantMessageDiv.parentElement.remove();
            }
            
            addMessage("assistant", `<em>‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ${err.message} ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</em>`);
        } finally {
            setProcessingState(false);
        }
    }
</script>

</body>
</html>
